name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: stable
          cache: true

      - name: Enable web & precache
        run: |
          flutter config --enable-web
          flutter precache --web

      - name: Clean and install dependencies
        working-directory: dashboard_web
        run: |
          flutter clean
          flutter pub get

      - name: Build web
        id: build
        working-directory: dashboard_web
        continue-on-error: true
        run: |
          set -o pipefail
          flutter build web --verbose --web-renderer html --no-tree-shake-icons --base-href=/2026-1-28-Figma-MCPto-Curosr/ 2>&1 | tee build.log || {
            echo "=== First 400 lines of build output (where dart2js often reports the real error) ==="
            head -400 build.log
            echo "=== Lines with Error/Exception ==="
            grep -n -i "error\|exception" build.log | tail -40
            echo "=== Last 80 lines ==="
            tail -80 build.log
            exit 1
          }

      - name: Upload build log on failure
        if: steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: dashboard_web/build.log

      - name: Fail if build failed
        if: steps.build.outcome == 'failure'
        run: exit 1

      - name: Deploy to GitHub Pages
        if: steps.build.outcome == 'success'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dashboard_web/build/web
          force_orphan: true
